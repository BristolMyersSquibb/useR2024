---
title: "No-Code Data Analysis and Dashboards with {blockr}"
author: "John Coene (The Y Company) and David Granjon (cynkra GmbH)"
format: 
  revealjs:
    #code-annotations: select
    footer: "Funded by <img class=\"mb-4\" src=\"assets/img/bms.svg\"/>"
    include-in-header:
      - text: |
          <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    css: [
      "assets/style/bootstrap.min.css",
      "assets/style/extra.css"
    ]
    view-distance: 5
    mermaid:
      theme: default
    height: 900
    width: 1600
    code-link: true
    code-copy: true
    fontsize: 24pt
    navigation-mode: vertical
    controls-layout: bottom-right
    controls-tutorial: true
    chalkboard: true
    transition: none
    background-transition: none
    title-slide-attributes:
        data-state: "hide-menubar"
    simplemenu:
        barhtml:
            header: "<div class='menubar'><ul class='menu'></ul><div>"
            #footer: "<img src='...' class='slide-logo r-stretch'>"
        scale: 0.67
revealjs-plugins:
  - simplemenu
  - attribution
filters:
  - quarto-ext/shinylive
editor:
    render-on-save: true
---

```{r setup}
library(shinylive)
library(bslib)
library(palmerpenguins)
library(ggplot2)
library(dplyr)
```

# A cooking approach to data science {background-image="assets/img/undraw_diet_ghvw.svg" background-size="contain" data-stack-name="Intro" style="margin-top: 450px;"}

<!--
Imagine if we could build an interactive datapipeline like we would prepare a meal ðŸ˜³
--->


## ![shiny logo](assets/img/shiny.svg){.center width=25%}

> __Easy__ web apps for data science without the compromises

## ~~Easy~~ Not so easy web apps for data science without the compromises {.center style="font-size: 1.5em"}

## Developing enterprise-grade dashboards isn't easy {background-image="assets/img/undraw_lost_re_xqjt.svg" background-size="contain" style="font-size: 1.5em"}

<!-- 
- Do you know how to prepare a meal without the right recipe?
- Do you have the right ingredients?
-->



## ðŸ’¡ Introducing {blockr}

::::{.columns}

:::{.column}
![](assets/img/undraw_empty_cart_co35.svg){width=50%}
:::

:::{.column}

:::{.incremental}
- __Supermarket__ for data analysis with R.
- __No-Code__ Dashboard builder for R.
- "Shiny's WordPress".
- Cut down development time from __weeks__ to __days__.
- Extendable.
- Reproducible code.
:::

:::

::::


# blockr 101 {data-stack-name="blockr 101" background-image="assets/img/undraw_cooking_p7m1.svg" background-size="contain" style="margin-top: -150px; margin-left: 50px;"}

## Palmer penguins plot

Plot me a histogram showing `flipper length` by `species` only for `female` penguins in 2009.

. . .

```{r}
#| echo: true
#| code-line-numbers: "1|2|3|4"
#| output-location: fragment
penguins |>
  filter(sex == "female", year == 2009) |>
  ggplot(aes(x = flipper_length_mm, y = body_mass_g)) +
  geom_point(aes(color = species, shape = species), size = 2)
```

## With blockr

```{shinylive-r}
#| standalone: true
#| components: [viewer]
#| viewerHeight: 800
webr::install("blockr", repos = c("https://blockr-org.github.io/webr-repos", "https://repo.r-wasm.org"))
library(blockr)
library(palmerpenguins)
library(ggplot2)

new_ggplot_block <- function(col_x = character(), col_y = character(), ...) {

  data_cols <- function(data) colnames(data)

  new_block(
    fields = list(
      x = new_select_field(col_x, data_cols, type = "name"),
      y = new_select_field(col_y, data_cols, type = "name")
    ),
    expr = quote(
      ggplot(mapping = aes(x = .(x), y = .(y)))
    ),
    class = c("ggplot_block", "plot_block"),
    ...
  )
}

new_geompoint_block <- function(color = character(), shape = character(), ...) {

  data_cols <- function(data) colnames(data$data)

  new_block(
    fields = list(
      color = new_select_field(color, data_cols, type = "name"),
      shape = new_select_field(shape, data_cols, type = "name")
    ),
    expr = quote(
      geom_point(aes(color = .(color), shape = .(shape)), size = 2)
    ),
    class = c("plot_layer_block", "plot_block"),
    ...
  )
}

stack <- new_stack(
  data_block = new_dataset_block("penguins", "palmerpenguins"), 
  plot_block = new_ggplot_block("flipper_length_mm", "body_mass_g"),
  layer_block = new_geompoint_block("species", "species")
)
serve_stack(stack)
```

## blockr vs Shiny

::::{.columns}
:::{.column}

Shiny
```{r, echo=TRUE, eval=FALSE}
library(shiny)
library(bslib)
library(ggplot2)
library(palmerpenguins)

shinyApp(
  ui = page_fluid(
    layout_sidebar(
      sidebar = sidebar(
        radioButtons("sex", "Sex", unique(penguins$sex), "female"),
        numericInput(
          "year", 
          "Year", 
          2009, 
          min(unique(penguins$year)),
         max(unique(penguins$year))
        ),
        selectInput(
          "xvar", 
          "X var", 
          colnames(dplyr::select(penguins, where(is.numeric))),
          "flipper_length_mm"
        ),
        selectInput(
          "yvar",
          "Y var",
          colnames(dplyr::select(penguins, where(is.numeric))),
          "body_mass_g"
        ),
        selectInput(
          "color",
          "Color and shape",
          colnames(dplyr::select(penguins, where(is.factor))),
          "species"
        )
      ),
      plotOutput("plot")
    )
  ),
  server = function(input, output, session) {
    output$plot <- renderPlot({
      penguins |>
        filter(sex == !!input$sex, year == !!input$year) |>
        ggplot(aes(x = !!input$xvar, y = !!input$yvar)) +
        geom_point(aes(color = !!input$color, shape = !!input$color), size = 2)
    })
  }
)
```
:::

:::{.column}
blockr
```{r, echo=TRUE, eval=FALSE}
library(blockr)
new_stack(
  data_block = new_dataset_block("penguins", "palmerpenguins"), 
  plot_block = new_ggplot_block("flipper_length_mm", "body_mass_g"),
  layer_block = new_geompoint_block("species", "species")
)
serve_stack(stack)
```
:::

::::

## Blocks and fields ðŸ¥¦ ðŸ¥š

::::{.columns}

:::{.column}
```{mermaid}
%%| mermaid-format: svg
%%| fig-width: 10
flowchart TD
  blk_data_in(Data input)
  blk_data_out[Output]
  subgraph blk_block[Block]
    subgraph blk_field1[Field 1]
      value(Value)
      title(Title)
      descr(Description)
      status(Status)
    end
    blk_field2(Field 2)
    blk_field1 --> blk_expr
    blk_field2 --> blk_expr
    blk_expr(Expression)
    blk_res(result)
    blk_expr --> blk_res
  end
  blk_data_in --> blk_block --> blk_data_out
```
:::

:::{.column}
- __Fields__ are __ingredients__.
- A __block__ is a recipe __step__.
:::

:::

::: {.content-visible when-profile="speaker"}
:::: {.notes}
A __block__ contains:

- __fields__, build the block expression and translated into Shiny inputs.
- An __expression__, evaluated with input data: `data |> select(<COLNAMES>)`.
- (Optional) input data.
- A __result__, of the evaluated expression.
- A __class__ for customization (see advanced part).
::::
:::

## How to build a `dplyr::filter` block?

::::{.columns}

:::{.column width="70%"}
```{mermaid}
%%| mermaid-format: svg
flowchart TD
  filt_data_in[Data input]
  filt_data_out[Transformed data]
  subgraph filt_block[Filter block]
    filt_select_col[Select columns]
    filt_filter_func[Filter function ==, !=]
    filt_filter_val[Filter values]
    filt_expr[Expression]
    filt_res[Result]

    filt_select_col --> filt_expr
    filt_select_col --> |depends| filt_filter_val
    filt_filter_val --> filt_expr
    filt_filter_func --> filt_expr

    filt_expr --> filt_res
  end
  filt_data_in --> filt_block --> filt_data_out
```
:::

:::{.column width="30%"}
```{r, echo=TRUE, eval=FALSE}
data |> filter(<COLNAME> <FILTER_FUNC> <FILTER_VALUE>, ...)

# data |> filter(col1 == "test")
```

3 __fields__:

- `<COLNAME>`
- `<FILTER_FUNC>`
- `<FILTER_VALUE>`: depends on `<COLNAME>`
:::

:::

## The stack: data analysis recipe

::::{.columns}

:::{.column}
```{mermaid}
%%| mermaid-format: svg
flowchart TD
  subgraph stack1[Stack]
    direction TB
    input(Data block: dataset, browser, ...);
    transform(Transform block: filter, select ...);
    output(Result: plot block);
    input --> transform --> output;
  end
```
:::

:::{.column}
Collection of instructions (blocks) from __data import__ to __wrangling/visualization__.
:::

::::

## The workspace: the dinner party {background-image="assets/img/undraw_special_event.svg" background-size="contain" style="margin-top: -50px"}


## The workspace

::::{.columns}

:::{.column width=70%}
```{mermaid}
%%| mermaid-format: svg
flowchart LR
  subgraph stack2[Stack 1]
    direction TB
    input_2(Data);
    transform_2(Transform);
    output_2(Result);
    input_2 --> transform_2 --> output_2;
  end
  stack2 --> stack3
  subgraph stack3[Stack 2]
    direction TB
    input_3(Data);
    transform_3(Transform);
    output_3(Visualize);
    input_3 --> transform_3 --> output_3;
  end
```
:::

:::{.column width=30%}
Collection of __recipes__ (stacks) to build a __dashboard__.
:::

::::

## How far can I go with blockr? {background-image="assets/img/undraw_add_post_re_174w.svg" background-size="cover" style="margin-left: 400px; margin-top: 700px"}



# Create your own block supermarket {data-stack-name="Extend" background-image="assets/img/undraw_empty_cart_co35.svg" background-size="cover" style="margin-top: -300px"}

## Today's mission

Create a new __count()__ block: `penguins %>% count(species)`

## Create new blocks: count block 1/4 {auto-animate=true}

::::{.columns}

:::{.column}
```{r, eval=FALSE, echo=TRUE}
new_count_block <- function(column = character(), ...) {

}
```
:::

:::{.column}
- Create the `constructor`.
:::

::::

## Create new blocks: count block 2/4 {auto-animate=true}

::::{.columns}

:::{.column}
```{r, eval=FALSE, echo=TRUE}
new_count_block <- function(column = character(), ...) {

  all_cols <- function(data) colnames(data)

  fields <- list(
    cols = new_select_field(column, all_cols, type = "name") # <1>
  )

  new_block(
    fields = fields,

  )
}
```
1. `type` allows to pass in cols as name instead of strings.
:::

:::{.column}
::: {style="color: gray;"}
- Create the `constructor`.
:::
- Add field(s): selected column.
:::

::::

## Create new blocks: count block 3/4 {auto-animate=true}

::::{.columns}

:::{.column}
```{r, eval=FALSE, echo=TRUE}
new_count_block <- function(column = character(), ...) {

  all_cols <- function(data) colnames(data)

  fields <- list(
    cols = new_select_field(column, all_cols, type = "name")
  )

  new_block(
    fields = fields,
    expr = quote(dplyr::count(.(cols))),
    ...
  )
}
```
:::

:::{.column}
::: {style="color: gray;"}
- Create the `constructor`.
- Add field(s): selected column.
:::
- Provide expression: use `quote` and pass field name with `.(field_name)`. ^[Needed by `bquote` for partial substitution.]
:::

::::

## Create new blocks: count block 4/4 {auto-animate=true}

::::{.columns}

:::{.column}
```{r, eval=FALSE, echo=TRUE}
new_count_block <- function(column = character(), ...) {

  all_cols <- function(data) colnames(data)

  fields <- list(
    cols = new_select_field(column, all_cols, type = "name")
  )

  new_block(
    fields = fields,
    expr = quote(dplyr::count(.(cols))),
    ...,
    class = c("count_block", "transform_block")
  )
}
```
:::

:::{.column}
::: {style="color: gray;"}
- Create the `constructor`.
- Add field(s): selected column.
- Provide expression: use `quote` and pass field name with `.(field_name)`. ^[Needed by `bquote` for partial substitution.]
:::
- Give it a right class: `transform_block` + a custom class.
:::

::::

## Demo

```{shinylive-r}
#| standalone: true
#| components: [viewer]
#| viewerHeight: 800
## file: app.R
webr::install("blockr", repos = c("https://blockr-org.github.io/webr-repos", "https://repo.r-wasm.org"))
library(blockr)
library(palmerpenguins)

new_count_block <- function(column = character(), ...) {

  all_cols <- function(data) colnames(data)

  fields <- list(
    cols = new_select_field(column, all_cols, type = "name")
  )

  new_block(
    fields = fields,
    expr = quote(dplyr::count(.(cols))),
    ...,
    class = c("count_block", "transform_block")
  )
}

stack <- new_stack(
  data_block = new_dataset_block("penguins", "palmerpenguins"), 
  count_block = new_count_block("species")
)
serve_stack(stack)
```

## How do we make the blocks available to users?

## The registry: the blocks supermarket {data-stack-name="Registry"}

::::{.columns}

:::{.column width=70%}
```{mermaid}
%%| mermaid-format: svg
flowchart LR
  subgraph blockr_ggplot2[blockr.ggplot2]
    new_block1[New block]
    new_block2[New block]
  end
  subgraph blockr_echarts4r[blockr.echarts4r]
    new_block3[New block]
    new_block4[New block]
  end
  blockr_ggplot2 --> |register| registry
  blockr_echarts4r --> |register| registry
  subgraph registry[Registry]
    subgraph select_reg[Select block]
      reg_name[Name: select block]
      reg_descr[Description: select columns in a table]
      reg_classes[Classes: select_block, tranform_block]
      reg_input[Input: data.frame]
      reg_output[Output: data.frame]
      reg_package[Package: blockr]
    end
    subgraph filter_reg[Filter block]
    end
    filter_reg --x |unregister| trash["fa:fa-trash"]
  end
```
:::

:::{.column width=30%}
- __Information__ about blocks. 
- __Shared__ between block packages.
:::

::::


## Customize blockr

:::{incremental}
- S3 programing: allows to customize behavior depending on object class
:::

```{mermaid}
%%| mermaid-format: svg
classDiagram
  class block
  block : +name
  block : +expr
  block : +result
  block : +layout
  block : +class
  block : +initialize_block(block)
  block : +is_initialized(block)
  block : +generate_code(block)
  block : +evaluate_block(block, ...)
  block : +generate_server(block, ...)
  block : +update_fields(block, ...)
```

# We need you! {data-stack-name="Conclusion"}

## Get started

```{r, eval=FALSE, echo=TRUE}
pak::pkg_install("blockr-org/blockr")

library(blockr)
serve_stack(new_stack())
```

## Use blocks and build dashboard

Share dashboard with your teams to speed up data analysis

## Create new blocks to help your data scientists

You're an advanced R developer, you can extend blockr!


## Our team

```{r}
library(shiny)
library(bslib)

tags$div(
  class = "row row-cols-1 row-cols-md-3 g-4",
  tags$div(
    class = "col",
    tags$div(
      class = "card h-100",
      #tags$img(
      #  src = "assets/img/bms.svg",
      #  class = "card-img-top m-auto",
      #  alt = "..."
      #),
      tags$div(
        class = "card-body",
        tags$h5(
          class = "card-title",
          "Karma Tarap"
        ),
        tags$img(
          src = "assets/img/bms.svg",
          alt = "..."
        )
      ),
      tags$div(
        class = "card-footer",
        tags$small(
          class = "text-body-secondary",
          a(href = "https://www.bms.com/", "https://www.bms.com/")
        )
      )
    )
  ),
  tags$div(
    class = "col",
    tags$div(
      class = "card h-100",
      #tags$img(
      #  src = "assets/img/ylogo.png",
      #  class = "card-img-top m-auto",
      #  alt = "...",
      #  width = "25%"
      #),
      tags$div(
        class = "card-body",
        tags$h5(
          class = "card-title",
          "John Coene"
        ),
        tags$img(
        src = "assets/img/ylogo-full.png",
        alt = "..."
      )
      ),
      tags$div(
        class = "card-footer",
        tags$small(
          class = "text-body-secondary",
          a(href = "https://the-y-company.com/", "https://the-y-company.com/")
        )
      )
    )
  ),
  tags$div(
    class = "col",
    tags$div(
      class = "card h-100",
      #tags$img(
      #  src = "assets/img/logo-cynkra.svg",
      #  class = "card-img-top m-auto",
      #  alt = "..."
      #),
      tags$div(
        class = "card-body",
        tags$h5(
          class = "card-title",
          "Nicolas Bennett, Christoph Sax, David Granjon"
        ),
        tags$img(
          src = "assets/img/logo-cynkra.svg",
          alt = "..."
        )
      ),
      tags$div(
        class = "card-footer",
        tags$small(
          class = "text-body-secondary",
          a(href = "https://cynkra.com/", "https://cynkra.com/")
        )
      )
    )
  )
)


#div(
#  class = "row row-cols-1 row-cols-md-3 g-4",
#  div(
#    class = "col",
#    card(
#      class = "h-100",
#      card_image("assets/img/bms.svg", class = "m-auto"),
#      card_title("Karma Tarap")
#    )
#  ),
#  div(
#    class = "col",
#    card(
#      class = "h-100",
#      card_image("assets/img/ylogo.png", width = "25%", class = "m-auto"),
#      card_title("John Coene")
#    )
#  ),
#  div(
#    class = "col",
#    card(
#      class = "h-100",
#      card_image("assets/img/logo-cynkra.svg", class = "m-auto"),
#      card_title("Nicolas Bennett, Christoph Sax, David Granjon")
#    )
#  )
#)
```